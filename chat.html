<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <title>Mega Chat</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { margin: 0; background: #0b141a; color: white; font-family: sans-serif; display: flex; height: 100vh; }
        .sidebar { width: 350px; background: #111b21; border-right: 1px solid #222d32; display: flex; flex-direction: column; }
        .stories { display: flex; padding: 15px; gap: 10px; overflow-x: auto; border-bottom: 1px solid #222d32; }
        .st-ring { width: 60px; height: 60px; border-radius: 50%; border: 2px solid #00a884; flex-shrink: 0; cursor: pointer; }
        
        .contact { padding: 15px; display: flex; align-items: center; gap: 12px; cursor: pointer; border-bottom: 1px solid #1c262d; }
        .contact:hover { background: #202c33; }
        
        .chat-view { flex: 1; display: flex; flex-direction: column; }
        .header { padding: 10px 20px; background: #202c33; display: flex; justify-content: space-between; align-items: center; }
        #msgs { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        
        .msg { padding: 10px; border-radius: 8px; max-width: 65%; font-size: 15px; }
        .sent { background: #005c4b; align-self: flex-end; }
        .rec { background: #202c33; align-self: flex-start; }
        
        .footer { padding: 10px; background: #202c33; display: flex; gap: 10px; align-items: center; }
        input { flex: 1; padding: 12px; border-radius: 20px; border: none; background: #2a3942; color: white; }
        
        #video-call { display: none; position: fixed; inset: 0; background: #000; z-index: 100; flex-direction: column; align-items: center; justify-content: center; }
        video { width: 45%; border-radius: 10px; border: 2px solid #00a884; }
    </style>
</head>
<body>

<div id="video-call">
    <div style="display:flex; gap:20px; width:100%; justify-content:center;">
        <video id="my-v" muted autoplay></video>
        <video id="peer-v" autoplay></video>
    </div>
    <button onclick="location.reload()" style="margin-top:20px; padding:15px 30px; background:red; border:none; color:white; border-radius:30px;">Аяқтау</button>
</div>

<div class="sidebar">
    <div class="stories">
        <label class="st-ring" style="display:flex; align-items:center; justify-content:center; background:#222;"><i class="fas fa-plus"></i><input type="file" hidden onchange="uploadFile(this, 'story')"></label>
    </div>
    <div style="padding:15px;"><input type="text" placeholder="Іздеу немесе Құпия код..." onkeyup="searchAction(this.value)" style="width:100%; padding:10px; border-radius:10px; background:#222; color:white; border:none;"></div>
    <div id="results"></div>
</div>

<div class="chat-view">
    <div class="header">
        <b id="chat-with">Чат таңдаңыз</b>
        <div style="color:#00a884; cursor:pointer;">
            <i class="fas fa-phone" onclick="startCall(false)" style="margin-right:20px;"></i>
            <i class="fas fa-video" onclick="startCall(true)"></i>
        </div>
    </div>
    <div id="msgs"></div>
    <div class="footer">
        <label style="cursor:pointer;"><i class="fas fa-paperclip"></i><input type="file" hidden onchange="uploadFile(this, 'chat')"></label>
        <input type="text" id="m-text" placeholder="Хабарлама жазу...">
        <button onclick="sendMsg()" style="background:none; border:none; color:#00a884; font-size:22px;"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<script>
    const socket = io();
    const myUser = localStorage.getItem('username');
    let activeChat = '', myStream, peer = new Peer(myUser);

    socket.emit('join', myUser);

    // Қоңырауды қабылдау (Звонок келгенде алу)
    navigator.mediaDevices.getUserMedia({video:true, audio:true}).then(s => {
        myStream = s; document.getElementById('my-v').srcObject = s;
    });

    peer.on('call', c => {
        if(confirm("Кіріс қоңырауы! Жауап бересіз бе?")) {
            document.getElementById('video-call').style.display='flex';
            c.answer(myStream);
            c.on('stream', rs => document.getElementById('peer-v').srcObject = rs);
        }
    });

    function startCall(v) {
        document.getElementById('video-call').style.display='flex';
        const c = peer.call(activeChat, myStream);
        c.on('stream', rs => document.getElementById('peer-v').srcObject = rs);
    }

    // Іздеу және Скрытый чатты кодпен ашу
    async function searchAction(q) {
        if(!q) return document.getElementById('results').innerHTML = '';
        const res = await fetch(`/search?q=${q}&user=${myUser}`);
        const result = await res.json();
        const cont = document.getElementById('results');
        cont.innerHTML = '';

        if(result.type === 'hidden') {
            cont.innerHTML = '<div style="padding:10px; color:#00a884">Жасырын чаттар:</div>';
            result.data.forEach(name => {
                const d = document.createElement('div');
                d.className = 'contact'; d.innerHTML = `<b>${name} (Hidden)</b>`;
                d.onclick = () => selectChat(name);
                cont.appendChild(d);
            });
        } else {
            result.data.forEach(u => {
                const d = document.createElement('div');
                d.className = 'contact'; d.innerHTML = `<img src="${u.avatar}" style="width:40px; border-radius:50%;"> <b>${u.name}</b>`;
                d.onclick = () => selectChat(u.name);
                
                // Чатты жасыру (Long press / Ұзақ басу)
                let timer;
                d.onmousedown = () => {
                    timer = setTimeout(() => {
                        const code = prompt("Жасыру коды:");
                        if(code) fetch('/hide-chat', {
                            method:'POST',
                            headers:{'Content-Type':'application/json'},
                            body: JSON.stringify({owner:myUser, target:u.name, code:code})
                        }).then(() => alert("Чат жасырылды!"));
                    }, 1000);
                };
                d.onmouseup = () => clearTimeout(timer);
                cont.appendChild(d);
            });
        }
    }

    // Файл жіберу (Качество сақталады)
    async function uploadFile(input, mode) {
        const fd = new FormData(); fd.append('file', input.files[0]);
        const r = await fetch('/upload', {method:'POST', body:fd});
        const d = await r.json();
        if(mode === 'chat') socket.emit('msg', {to:activeChat, from:myUser, file:d.url, fType:d.type});
    }

    function selectChat(n) { activeChat = n; document.getElementById('chat-with').innerText = n; document.getElementById('msgs').innerHTML = ''; }

    function sendMsg() {
        const i = document.getElementById('m-text');
        if(i.value) { socket.emit('msg', {to:activeChat, from:myUser, text:i.value}); i.value = ''; }
    }

    socket.on('msg', d => {
        if(d.from === activeChat || d.from === myUser) {
            const div = document.createElement('div');
            div.className = `msg ${d.from === myUser ? 'sent' : 'rec'}`;
            if(d.text) div.innerText = d.text;
            if(d.file) {
                if(d.fType.includes('image')) div.innerHTML += `<img src="${d.file}" style="max-width:100%; border-radius:5px; margin-top:5px;">`;
                else if(d.fType.includes('video')) div.innerHTML += `<video src="${d.file}" controls style="max-width:100%; border-radius:5px; margin-top:5px;"></video>`;
                else div.innerHTML += `<br><a href="${d.file}" download style="color:#00a884">Файл жіберілді</a>`;
            }
            document.getElementById('msgs').appendChild(div);
        }
    });
</script>
</body>
</html>
