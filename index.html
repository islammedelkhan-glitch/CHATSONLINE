<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messenger Online</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="auth-box">
        <h1>Messenger</h1>
        <input type="text" id="user" placeholder="Логин">
        <input type="password" id="pass" placeholder="Пароль">
        <button onclick="auth('login')">Войти</button>
        <button onclick="auth('register')" style="background: #555;">Регистрация</button>
    </div>

    <div id="chat-box" style="display: none;">
        <div class="sidebar">
            <h4>Поиск друга / Группы</h4>
            <input type="text" id="room-id" placeholder="ID друга или имя комнаты">
            <button onclick="changeRoom()">Найти и войти</button>
            <hr>
            <p>Сейчас в: <b id="current-room">Global</b></p>
        </div>
        <div class="main">
            <div id="messages"></div>
            <div class="footer">
                <input type="text" id="m-text" placeholder="Введите сообщение...">
                <button onclick="sendMessage()">➤</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myUsername = "";
        let currentRoom = "Global";

        async function auth(type) {
            const username = document.getElementById('user').value;
            const password = document.getElementById('pass').value;
            if(!username || !password) return alert("Заполните поля");

            const res = await fetch('/' + type, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username, password })
            });
            const data = await res.json();

            if (data.success) {
                if (type === 'login') {
                    myUsername = data.username;
                    document.getElementById('auth-box').style.display = 'none';
                    document.getElementById('chat-box').style.display = 'flex';
                    changeRoom();
                } else {
                    alert("Регистрация успешна! Теперь нажми Войти.");
                }
            } else {
                alert(data.message);
            }
        }

        function changeRoom() {
            const newRoom = document.getElementById('room-id').value || "Global";
            currentRoom = newRoom;
            document.getElementById('current-room').innerText = currentRoom;
            document.getElementById('messages').innerHTML = "";
            socket.emit('join', { username: myUsername, room: currentRoom });
        }

        function sendMessage() {
            const text = document.getElementById('m-text').value;
            if (text) {
                socket.emit('message', { room: currentRoom, user: myUsername, text });
                document.getElementById('m-text').value = "";
            }
        }

        socket.on('msg', (data) => {
            const div = document.createElement('div');
            div.className = 'message';
            div.innerHTML = `<b>${data.user}:</b> <span>${data.text}</span>`;
            document.getElementById('messages').appendChild(div);
            document.getElementById('messages').scrollTop = 9999;
        });
    </script>
</body>
</html>